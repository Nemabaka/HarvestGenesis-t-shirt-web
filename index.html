import React, { useMemo, useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { ShoppingCart, Shirt, Trash2, X, ChevronRight, Mail } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

/**
 * HarvestGENESIS – Single‑File React App (Previewable in ChatGPT Canvas)
 *
 * Notes:
 * - Colors: black, white, dark turquoise (#0097b2). Tailwind classes use these.
 * - All images are inline SVGs, so no external links required.
 * - Fully functional cart (persisted to localStorage) with size & color.
 * - "Request a Quote" form composes an email (mailto:) to your address by default.
 *   Optionally enable EmailJS by adding your keys at the TODO block below.
 * - Prices start at R350. Quantities supported. Totals computed in ZAR.
 */

// ----------- Config -----------
const BRAND = {
  name: "HarvestGENESIS",
  accent: "#0097b2",
  email: "khanonemabaka2@gmail.com", // TODO: change if you prefer a different inbox
  basePrice: 350,
  sizes: ["S", "M", "L", "XL", "2XL"],
  colors: [
    { id: "black", name: "Black", hex: "#111111", text: "#ffffff", border: "#222" },
    { id: "white", name: "White", hex: "#ffffff", text: "#111111", border: "#e5e7eb" },
  ],
};

// Optional: EmailJS (client-side email sending)
// 1) npm packages are available in this environment; however, to keep this single-file self-contained,
//    we keep EmailJS integration minimal and lazy. If keys remain empty, the app falls back to mailto.
// 2) Create an account at https://www.emailjs.com/, then set the 3 values below.
const EMAILJS = {
  ENABLED: false, // set true after adding your keys
  SERVICE_ID: "", // e.g., "service_123abc"
  TEMPLATE_ID: "", // e.g., "template_xyz789"
  PUBLIC_KEY: "", // e.g., "hHjKLMnoPQR123"
};

// ----------- Utilities -----------
const currency = (n) => new Intl.NumberFormat("en-ZA", { style: "currency", currency: "ZAR" }).format(n);
const key = (p) => `hg_cart_${p}`;

function useLocalStorage(keyName, initialValue) {
  const [value, setValue] = useState(() => {
    try {
      const item = localStorage.getItem(keyName);
      return item ? JSON.parse(item) : initialValue;
    } catch {
      return initialValue;
    }
  });
  useEffect(() => {
    try { localStorage.setItem(keyName, JSON.stringify(value)); } catch {}
  }, [keyName, value]);
  return [value, setValue];
}

// ----------- SVG "Product images" -----------
function TeeSVG({ color = "#111111", textColor = "#ffffff", accent = BRAND.accent, variant = 1 }) {
  // Four variants via subtle layout differences
  const v = variant % 4;
  return (
    <svg viewBox="0 0 600 600" className="w-full h-56 rounded-2xl shadow-inner" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stopColor="rgba(255,255,255,0.12)" />
          <stop offset="100%" stopColor="rgba(0,0,0,0.12)" />
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="600" height="600" rx="24" fill={color} />
      <rect x="0" y="0" width="600" height="600" rx="24" fill="url(#g)" />
      {/* Minimal tee outline */}
      <path d="M170 160 L240 120 L360 120 L430 160 L400 210 L400 460 Q400 500 360 500 L240 500 Q200 500 200 460 L200 210 Z" fill={color} stroke={v % 2 ? accent : "#00000022"} strokeWidth="6" />
      {/* Brand mark */}
      <g transform={`translate(${v===0?230:v===1?210:v===2?220:200} ${v===3?260:240})`}>
        <rect x="-60" y="-40" width="220" height="80" rx="12" fill={accent} opacity="0.9" />
        <text x="50" y="10" fill={textColor} fontFamily="Inter, ui-sans-serif" fontSize="28" fontWeight="700" textAnchor="middle">
          HG TEES
        </text>
      </g>
      {/* Subtext */}
      <text x="300" y="520" fill={textColor} fontFamily="Inter, ui-sans-serif" fontSize="22" textAnchor="middle" opacity="0.9">
        HarvestGENESIS — Built For You
      </text>
    </svg>
  );
}

// ----------- Data -----------
const PRODUCTS = [1, 2, 3, 4].map((i) => ({
  id: `tees-${i}`,
  title: `HG Classic Tee ${i}`,
  price: BRAND.basePrice,
  description: "Premium cotton tee with durable print. Comfortable, versatile, and made to last.",
  variant: i,
}));

// ----------- Cart Types -----------
function lineItemKey({ id, size, color }) {
  return `${id}_${size}_${color}`;
}

// ----------- Components -----------
function Header({ onOpenCart }) {
  return (
    <header className="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/60 bg-white/70 dark:bg-black/70 border-b border-neutral-200 dark:border-neutral-800">
      <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-9 h-9 rounded-2xl bg-[var(--accent)] flex items-center justify-center shadow">
            <Shirt className="w-5 h-5 text-white" />
          </div>
          <span className="text-xl font-bold tracking-tight">Harvest<span className="text-[var(--accent)]">GENESIS</span></span>
        </div>
        <nav className="hidden sm:flex items-center gap-6 text-sm">
          <a href="#products" className="hover:text-[var(--accent)]">Products</a>
          <a href="#quote" className="hover:text-[var(--accent)]">Request a Quote</a>
          <a href="#about" className="hover:text-[var(--accent)]">About</a>
        </nav>
        <Button onClick={onOpenCart} className="rounded-2xl shadow-lg">
          <ShoppingCart className="w-4 h-4 mr-2" /> Cart
        </Button>
      </div>
    </header>
  );
}

function ProductCard({ p, onAdd }) {
  const [size, setSize] = useState(BRAND.sizes[1]);
  const [color, setColor] = useState(BRAND.colors[0].id);
  const colorMeta = useMemo(() => BRAND.colors.find(c => c.id === color)!, [color]);

  return (
    <Card className="rounded-2xl overflow-hidden border-neutral-200 dark:border-neutral-800">
      <CardHeader className="pb-0">
        <CardTitle className="text-lg flex items-center justify-between">
          <span>{p.title}</span>
          <span className="text-[var(--accent)] font-semibold">{currency(p.price)}</span>
        </CardTitle>
      </CardHeader>
      <CardContent className="pt-4">
        <TeeSVG color={colorMeta.hex} textColor={colorMeta.text} accent={BRAND.accent} variant={p.variant} />
        <p className="mt-3 text-sm text-neutral-600 dark:text-neutral-300">{p.description}</p>

        <div className="mt-4 grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs uppercase tracking-wide text-neutral-500">Size</label>
            <div className="mt-2 flex flex-wrap gap-2">
              {BRAND.sizes.map((s) => (
                <button
                  key={s}
                  onClick={() => setSize(s)}
                  className={`px-3 py-1.5 rounded-xl border text-sm ${
                    s === size
                      ? "bg-[var(--accent)] text-white border-transparent"
                      : "border-neutral-300 dark:border-neutral-700 hover:border-[var(--accent)]"
                  }`}
                >
                  {s}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="text-xs uppercase tracking-wide text-neutral-500">Color</label>
            <div className="mt-2 flex items-center gap-2">
              {BRAND.colors.map((c) => (
                <button
                  key={c.id}
                  onClick={() => setColor(c.id)}
                  title={c.name}
                  className={`w-9 h-9 rounded-full border-2 ${
                    color === c.id ? "border-[var(--accent)] scale-105" : "border-neutral-300 dark:border-neutral-700"
                  } transition-transform`}
                  style={{ backgroundColor: c.hex }}
                />
              ))}
            </div>
          </div>
        </div>

        <div className="mt-4 flex items-center justify-between">
          <Button onClick={() => onAdd({ ...p, size, color })} className="rounded-2xl">
            <ShoppingCart className="w-4 h-4 mr-2" /> Add to Cart
          </Button>
          <a href="#quote" className="text-sm hover:text-[var(--accent)] flex items-center">Get a quote <ChevronRight className="w-4 h-4 ml-1"/></a>
        </div>
      </CardContent>
    </Card>
  );
}

function CartDrawer({ open, onClose, items, updateQty, removeItem }) {
  const total = items.reduce((sum, it) => sum + it.price * it.qty, 0);
  return (
    <AnimatePresence>
      {open && (
        <motion.aside
          initial={{ x: "100%" }}
          animate={{ x: 0 }}
          exit={{ x: "100%" }}
          transition={{ type: "spring", stiffness: 260, damping: 22 }}
          className="fixed top-0 right-0 h-full w-full sm:w-[420px] bg-white dark:bg-neutral-950 shadow-2xl z-50 border-l border-neutral-200 dark:border-neutral-800"
        >
          <div className="flex items-center justify-between px-4 py-3 border-b border-neutral-200 dark:border-neutral-800">
            <h3 className="text-lg font-semibold">Your Cart</h3>
            <button onClick={onClose} className="p-2 rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-900">
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="p-4 space-y-4 overflow-y-auto h-[calc(100%-160px)]">
            {items.length === 0 && (
              <p className="text-sm text-neutral-600 dark:text-neutral-300">Your cart is empty.</p>
            )}
            {items.map((it) => (
              <div key={lineItemKey(it)} className="flex gap-3 items-center border rounded-2xl p-3 border-neutral-200 dark:border-neutral-800">
                <div className="w-20 shrink-0">
                  <TeeSVG color={it.colorHex} textColor={it.textColor} accent={BRAND.accent} variant={it.variant} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="font-medium truncate">{it.title}</div>
                  <div className="text-xs text-neutral-500">{it.colorName} · {it.size}</div>
                  <div className="mt-1 flex items-center gap-2">
                    <button onClick={() => updateQty(it, Math.max(1, it.qty - 1))} className="px-2 py-1 border rounded-lg">-</button>
                    <span className="min-w-[2ch] text-center">{it.qty}</span>
                    <button onClick={() => updateQty(it, it.qty + 1)} className="px-2 py-1 border rounded-lg">+</button>
                  </div>
                </div>
                <div className="text-right">
                  <div className="font-semibold">{currency(it.price * it.qty)}</div>
                  <button onClick={() => removeItem(it)} className="text-xs text-red-600 hover:underline inline-flex items-center mt-1"><Trash2 className="w-3 h-3 mr-1"/>Remove</button>
                </div>
              </div>
            ))}
          </div>

          <div className="p-4 border-t border-neutral-200 dark:border-neutral-800">
            <div className="flex items-center justify-between font-semibold">
              <span>Subtotal</span>
              <span>{currency(total)}</span>
            </div>
            <a href="#quote">
              <Button className="w-full mt-3 rounded-2xl">Proceed to Quote</Button>
            </a>
          </div>
        </motion.aside>
      )}
    </AnimatePresence>
  );
}

function QuoteForm({ cart, onSubmitted }) {
  const [form, setForm] = useState({
    fullName: "",
    email: "",
    phone: "",
    message: "",
  });

  const orderSummary = useMemo(() => {
    if (!cart.length) return "No items in cart.";
    return cart
      .map((it) => `${it.title} — ${it.size} / ${it.colorName} x${it.qty} @ ${currency(it.price)} = ${currency(it.price * it.qty)}`)
      .join("\n");
  }, [cart]);

  const total = useMemo(() => cart.reduce((s, it) => s + it.price * it.qty, 0), [cart]);

  const mailtoHref = useMemo(() => {
    const subject = encodeURIComponent(`Quote Request — ${form.fullName || "Customer"}`);
    const body = encodeURIComponent(
      `Name: ${form.fullName}\nEmail: ${form.email}\nPhone: ${form.phone}\n\nOrder Details:\n${orderSummary}\n\nTotal (approx): ${currency(total)}\n\nMessage:\n${form.message}`
    );
    return `mailto:${BRAND.email}?subject=${subject}&body=${body}`;
  }, [form, orderSummary, total]);

  const canSubmit = form.fullName && (form.email || form.phone);

  async function handleSubmit(e) {
    e.preventDefault();

    if (EMAILJS.ENABLED && EMAILJS.SERVICE_ID && EMAILJS.TEMPLATE_ID && EMAILJS.PUBLIC_KEY) {
      try {
        const payload = {
          service_id: EMAILJS.SERVICE_ID,
          template_id: EMAILJS.TEMPLATE_ID,
          user_id: EMAILJS.PUBLIC_KEY,
          template_params: {
            full_name: form.fullName,
            email: form.email,
            phone: form.phone,
            message: form.message,
            order_summary: orderSummary,
            total_amount: currency(total),
          },
        };
        const res = await fetch("https://api.emailjs.com/api/v1.0/email/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("EmailJS request failed");
        onSubmitted?.();
        alert("Quote request sent! We'll get back to you soon.");
        return;
      } catch (err) {
        console.error(err);
        alert("EmailJS failed. Falling back to your email client…");
      }
    }

    // Fallback: open email client with prefilled details
    window.location.href = mailtoHref;
    onSubmitted?.();
  }

  return (
    <Card id="quote" className="rounded-2xl border-neutral-200 dark:border-neutral-800">
      <CardHeader>
        <CardTitle className="flex items-center"><Mail className="w-5 h-5 mr-2"/> Request a Quote</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="grid sm:grid-cols-2 gap-4">
          <div className="sm:col-span-2">
            <label className="text-sm">Full Name</label>
            <input
              required
              className="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950"
              placeholder="Your name"
              value={form.fullName}
              onChange={(e) => setForm({ ...form, fullName: e.target.value })}
            />
          </div>
          <div>
            <label className="text-sm">Email</label>
            <input
              type="email"
              className="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950"
              placeholder="you@example.com"
              value={form.email}
              onChange={(e) => setForm({ ...form, email: e.target.value })}
            />
          </div>
          <div>
            <label className="text-sm">Phone</label>
            <input
              className="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950"
              placeholder="072 000 0000"
              value={form.phone}
              onChange={(e) => setForm({ ...form, phone: e.target.value })}
            />
          </div>
          <div className="sm:col-span-2">
            <label className="text-sm">Message (optional)</label>
            <textarea
              rows={4}
              className="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950"
              placeholder="Tell us about your design, quantities, deadline, etc."
              value={form.message}
              onChange={(e) => setForm({ ...form, message: e.target.value })}
            />
          </div>

          <div className="sm:col-span-2 bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-4">
            <div className="font-medium mb-2">Order Summary</div>
            <pre className="text-sm whitespace-pre-wrap">{orderSummary}</pre>
            <div className="mt-2 font-semibold">Estimated total: {currency(total)}</div>
          </div>

          <div className="sm:col-span-2">
            <Button type="submit" disabled={!canSubmit} className="rounded-2xl w-full sm:w-auto">
              Send Quote Request
            </Button>
            {!canSubmit && <p className="text-xs text-neutral-500 mt-2">Enter your name and at least an email or phone number.</p>}
          </div>
        </form>
        <p className="text-xs text-neutral-500 mt-3">
          Tip: To enable direct sending without opening your email client, switch on EmailJS in the code (set ENABLED to true and add your keys).
        </p>
      </CardContent>
    </Card>
  );
}

export default function App() {
  const [cart, setCart] = useLocalStorage(key("v1"), []);
  const [open, setOpen] = useState(false);

  const addToCart = (p) => {
    const cm = BRAND.colors.find((c) => c.id === p.color)!;
    const item = {
      id: p.id,
      title: p.title,
      price: p.price,
      size: p.size,
      color: p.color,
      colorName: cm.name,
      colorHex: cm.hex,
      textColor: cm.text,
      variant: p.variant,
      qty: 1,
    };
    setCart((prev) => {
      const idx = prev.findIndex((x) => lineItemKey(x) === lineItemKey(item));
      if (idx >= 0) {
        const copy = [...prev];
        copy[idx] = { ...copy[idx], qty: copy[idx].qty + 1 };
        return copy;
      }
      return [...prev, item];
    });
    setOpen(true);
  };

  const updateQty = (it, qty) => {
    setCart((prev) => prev.map((x) => (lineItemKey(x) === lineItemKey(it) ? { ...x, qty } : x)));
  };

  const removeItem = (it) => {
    setCart((prev) => prev.filter((x) => lineItemKey(x) !== lineItemKey(it)));
  };

  useEffect(() => {
    // Ensure CSS variables for accent are available
    document.documentElement.style.setProperty("--accent", BRAND.accent);
  }, []);

  return (
    <div className="min-h-screen bg-white dark:bg-neutral-950 text-neutral-900 dark:text-neutral-50">
      <Header onOpenCart={() => setOpen(true)} />

      {/* Hero */}
      <section className="relative overflow-hidden">
        <div className="max-w-6xl mx-auto px-4 py-16 sm:py-24 grid md:grid-cols-2 gap-10 items-center">
          <div>
            <h1 className="text-4xl sm:text-5xl font-extrabold leading-tight">
              Custom T‑Shirts, <span className="text-[var(--accent)]">Made Simple</span>
            </h1>
            <p className="mt-4 text-neutral-600 dark:text-neutral-300 text-lg">
              Order premium tees from HarvestGENESIS in <b>Black</b> or <b>White</b>, sizes S–2XL. Prices start at {currency(BRAND.basePrice)}.
            </p>
            <div className="mt-6 flex gap-3">
              <a href="#products"><Button className="rounded-2xl">Browse Tees</Button></a>
              <a href="#quote" className="inline-flex items-center px-4 py-2 rounded-2xl border border-neutral-300 dark:border-neutral-700 hover:border-[var(--accent)]">Request a Quote</a>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-4">
            {BRAND.colors.map((c, i) => (
              <div key={c.id} className={`rounded-3xl p-3 border ${i%2?"-mt-6":"mt-6"} border-neutral-200 dark:border-neutral-800`}>
                <TeeSVG color={c.hex} textColor={c.text} accent={BRAND.accent} variant={i+1} />
              </div>
            ))}
          </div>
        </div>
        <div className="absolute inset-x-0 -bottom-24 h-48 bg-[var(--accent)]/10 blur-3xl" />
      </section>

      {/* Products */}
      <section id="products" className="max-w-6xl mx-auto px-4 py-12">
        <h2 className="text-2xl font-bold mb-6">Products</h2>
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {PRODUCTS.map((p) => (
            <ProductCard key={p.id} p={p} onAdd={addToCart} />
          ))}
        </div>
      </section>

      {/* Quote */}
      <section className="max-w-6xl mx-auto px-4 py-12">
        <QuoteForm cart={cart} onSubmitted={() => {}} />
      </section>

      {/* About */}
      <section id="about" className="max-w-6xl mx-auto px-4 pb-20">
        <Card className="rounded-2xl border-neutral-200 dark:border-neutral-800">
          <CardHeader>
            <CardTitle>About HarvestGENESIS</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-neutral-700 dark:text-neutral-300">
              We help people and businesses with brand essentials — from resumes and applications to posters, flyers, and now custom T‑shirts. 
              Our tees are printed with care and delivered with professional service.
            </p>
          </CardContent>
        </Card>
      </section>

      <footer className="border-t border-neutral-200 dark:border-neutral-800">
        <div className="max-w-6xl mx-auto px-4 py-8 flex flex-col sm:flex-row items-center justify-between gap-3 text-sm">
          <div className="flex items-center gap-2">
            <Shirt className="w-4 h-4" />
            <span>© {new Date().getFullYear()} HarvestGENESIS</span>
          </div>
          <div className="opacity-70">Made with ❤ in South Africa • Accent {BRAND.accent}</div>
        </div>
      </footer>

      <CartDrawer open={open} onClose={() => setOpen(false)} items={cart} updateQty={updateQty} removeItem={removeItem} />
    </div>
  );
}

// Tailwind utility: ensure base styles for preview (Canvas already injects Tailwind, but these help consistency)
const style = document.createElement("style");
style.innerHTML = `
:root { --accent: ${BRAND.accent}; }
body { background: #0a0a0a; }
`;
document.head.appendChild(style);

